name: EAS Build and Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Build environment'
        required: true
        default: 'preview'
        type: choice
        options:
          - development
          - preview
          - staging
          - production
      platform:
        description: 'Build platform'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - android
          - ios
      submit:
        description: 'Submit to app stores'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  EXPO_CLI_VERSION: 'latest'
  EAS_CLI_VERSION: 'latest'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/mobile/package-lock.json

      - name: Install dependencies
        working-directory: apps/mobile
        run: npm ci

      - name: Run linting
        working-directory: apps/mobile
        run: npm run lint

      - name: Run type checking
        working-directory: apps/mobile
        run: npm run type-check

      - name: Run unit tests
        working-directory: apps/mobile
        run: npm run test:unit

      - name: Run integration tests
        working-directory: apps/mobile
        run: npm run test:integration

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: test
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'android' || github.event.inputs.platform == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/mobile/package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        working-directory: apps/mobile
        run: npm ci

      - name: Setup Expo CLI
        run: npm install -g @expo/cli@${{ env.EXPO_CLI_VERSION }}

      - name: Setup EAS CLI
        run: npm install -g @expo/eas-cli@${{ env.EAS_CLI_VERSION }}

      - name: Login to Expo
        run: eas login --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Determine build profile
        id: profile
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "profile=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "profile=staging" >> $GITHUB_OUTPUT
          else
            echo "profile=${{ github.event.inputs.environment || 'preview' }}" >> $GITHUB_OUTPUT
          fi

      - name: Build Android App
        working-directory: apps/mobile
        run: |
          eas build \
            --platform android \
            --profile ${{ steps.profile.outputs.profile }} \
            --non-interactive \
            --wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_ALIAS: ${{ secrets.ANDROID_KEYSTORE_ALIAS }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: apps/mobile/build/
          retention-days: 30

  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: test
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'ios' || github.event.inputs.platform == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/mobile/package-lock.json

      - name: Install dependencies
        working-directory: apps/mobile
        run: npm ci

      - name: Setup Expo CLI
        run: npm install -g @expo/cli@${{ env.EXPO_CLI_VERSION }}

      - name: Setup EAS CLI
        run: npm install -g @expo/eas-cli@${{ env.EAS_CLI_VERSION }}

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Login to Expo
        run: eas login --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Determine build profile
        id: profile
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "profile=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "profile=staging" >> $GITHUB_OUTPUT
          else
            echo "profile=${{ github.event.inputs.environment || 'preview' }}" >> $GITHUB_OUTPUT
          fi

      - name: Build iOS App
        working-directory: apps/mobile
        run: |
          eas build \
            --platform ios \
            --profile ${{ steps.profile.outputs.profile }} \
            --non-interactive \
            --wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: apps/mobile/build/
          retention-days: 30

  submit-android:
    name: Submit Android to Play Store
    runs-on: ubuntu-latest
    needs: build-android
    if: |
      (github.event.inputs.submit == 'true' && github.event.inputs.platform != 'ios') ||
      (github.ref == 'refs/heads/main' && github.event_name == 'push')
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: apps/mobile
        run: npm ci

      - name: Setup EAS CLI
        run: npm install -g @expo/eas-cli@${{ env.EAS_CLI_VERSION }}

      - name: Login to Expo
        run: eas login --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Submit to Play Store
        working-directory: apps/mobile
        run: |
          eas submit \
            --platform android \
            --profile production \
            --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}

  submit-ios:
    name: Submit iOS to App Store
    runs-on: macos-latest
    needs: build-ios
    if: |
      (github.event.inputs.submit == 'true' && github.event.inputs.platform != 'android') ||
      (github.ref == 'refs/heads/main' && github.event_name == 'push')
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: apps/mobile
        run: npm ci

      - name: Setup EAS CLI
        run: npm install -g @expo/eas-cli@${{ env.EAS_CLI_VERSION }}

      - name: Login to Expo
        run: eas login --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Submit to App Store
        working-directory: apps/mobile
        run: |
          eas submit \
            --platform ios \
            --profile production \
            --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: always()
    steps:
      - name: Notify on Success
        if: needs.build-android.result == 'success' || needs.build-ios.result == 'success'
        run: |
          echo "✅ Build completed successfully!"
          # Add Slack/Discord notification here if needed

      - name: Notify on Failure
        if: needs.build-android.result == 'failure' || needs.build-ios.result == 'failure'
        run: |
          echo "❌ Build failed!"
          # Add Slack/Discord notification here if needed

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [build-android, build-ios, submit-android, submit-ios]
    if: always()
    steps:
      - name: Cleanup old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            const oldArtifacts = artifacts.data.artifacts
              .filter(artifact => artifact.created_at < new Date(Date.now() - 30 * 24 * 60 * 60 * 1000))
              .map(artifact => artifact.id);

            for (const artifactId of oldArtifacts) {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifactId,
              });
            }